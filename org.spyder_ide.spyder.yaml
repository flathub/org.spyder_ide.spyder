app-id: org.spyder_ide.spyder
runtime: org.kde.Sdk
runtime-version: 5.15-24.08
sdk: org.kde.Sdk
command: spyder-wrapper
rename-desktop-file: spyder.desktop
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-24.08
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
  - --share=network # For installing extra libs
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess # fix QTWEBENGINEPROCESS not found
  - --env=FLATPAK_ISOLATE_PIP=1
  - --env=FLATPAK_IDE_LOGLEVEL=1
  - --env=FLATPAK_PREFER_USER_PACKAGES=1
  - --env=PYTHONPATH=/app/org.spyder_ide.spyder/data/python/lib/python3.12/
  - --env=PYTHONSTARTUP=/app/etc/pythonstart
modules:
  - name: openblas # dependency for scipy and numpy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
      - -DDYNAMIC_ARCH:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.30.tar.gz
        sha256: 27342cff518646afb4c2b976d809102e368957974c250a25ccc965e53063c95d
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

    # For rtree
  - name: libspatialindex
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/libspatialindex/libspatialindex/releases/download/2.1.0/spatialindex-src-2.1.0.tar.bz2
        sha256: c59932395e98896038d59199f2e2453595df6d730ffbe09d69df2a661bcb619b
        x-checker-data:
          type: anitya
          project-id: 4864
          stable-only: true
          url-template: https://github.com/libspatialindex/libspatialindex/releases/download/$version/spatialindex-src-$version.tar.bz2

  - name: libzmq
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.5/zeromq-4.3.5.tar.gz
        sha256: 6653ef5910f17954861fe72332e68b03ca6e4d9c7160eb3a8de5a5a913bfab43
        x-checker-data:
          type: anitya
          project-id: 16245
          stable-only: true
          url-template: https://github.com/zeromq/libzmq/releases/download/v$version/zeromq-$version.tar.gz

  - name: PyYAML
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --ignore-installed --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/54/ed/79a089b6be93607fa5cdaedf301d7dfb23af5f25c398d5ead2525b063e17/pyyaml-6.0.2.tar.gz
        sha256: d584d9ec91ad65861cc08d42e834324ef890a082e591037abe114850ff7bbc3e
        x-checker-data:
          type: pypi
          name: pyyaml

  - name: Cython
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --ignore-installed --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/a7/f6/d762df1f436a0618455d37f4e4c4872a7cd0dcfc8dec3022ee99e4389c69/cython-3.1.4.tar.gz
        sha256: 9aefefe831331e2d66ab31799814eae4d0f8a2d246cbaaaa14d1be29ef777683
        # Statsmodel fail to build with newer version
        x-checker-data:
          type: pypi
          name: Cython

    # Run ./generate_python_deps.sh to generate and update these dependencies
  - spyder_deps_additional.json
  - spyder_deps_1.json
  - spyder_deps_2.json
  - spyder_deps_3.json
  - spyder_deps_rust.json
  - spyder_deps_terminal.json

  - name: python-numpy
    buildsystem: simple
    build-options:
      ldflags: -lgfortran
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/d0/19/95b3d357407220ed24c139018d2518fab0a61a948e68286a25f1a4d049ff/numpy-2.3.3.tar.gz
        sha256: ddc7c39727ba62b80dfdbedf400d1c10ddfa8eefbd7ec8dcb118be8b56d31029
        x-checker-data:
          type: pypi
          name: numpy

  - spyder_deps_numerical.json

  - name: python-scipy
    buildsystem: simple
    build-options:
      ldflags: -lgfortran
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4c/3b/546a6f0bfe791bbb7f8d591613454d15097e53f906308ec6f7c1ce588e8e/scipy-1.16.2.tar.gz
        sha256: af029b153d243a80afb6eabe40b0a07f8e35c9adc269c019f364ad747f826a6b
        x-checker-data:
          type: pypi
          name: scipy

  - name: python-statsmodels
    buildsystem: simple
    # build-options:
    #   ldflags: -lgfortran
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/64/cc/8c1bf59bf8203dea1bf2ea811cfe667d7bcc6909c83d8afb02b08e30f50b/statsmodels-0.14.5.tar.gz
        sha256: de260e58cccfd2ceddf835b55a357233d6ca853a1aa4f90f7553a52cc71c6ddf
        x-checker-data:
          type: pypi
          name: statsmodels

  - name: python3-matplotlib
    buildsystem: simple
    build-commands:
      - mkdir -p subprojects/packagecache/
      - cp qhull-8.0.2.tgz freetype-2.6.1.tar.gz subprojects/packagecache/ #Copy qhull and freetype to correct dir so matplotlib will not try to download it
      - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation
    sources:
      - type: file
        url: https://download.savannah.gnu.org/releases/freetype/freetype-old/freetype-2.6.1.tar.gz
        sha256: 0a3c7dfbda6da1e8fce29232e8e96d987ababbbf71ebc8c75659e4132c367014
        dest-filename: freetype-2.6.1.tar.gz
      - type: file
        dest-filename: qhull-8.0.2.tgz
        url: https://github.com/qhull/qhull/archive/v8.0.2/qhull-8.0.2.tar.gz
        sha256: 8774e9a12c70b0180b95d6b0b563c5aa4bea8d5960c15e18ae3b6d2521d64f8b
      - type: archive
        url: https://files.pythonhosted.org/packages/a0/59/c3e6453a9676ffba145309a73c462bb407f4400de7de3f2b41af70720a3c/matplotlib-3.10.6.tar.gz
        sha256: ec01b645840dd1996df21ee37f208cd8ba57644779fa20464010638013d3203c
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: spyder-kernels
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/80/91/486bcaa9a2b94ec40adbaca55cd0c983560bed1442d62b441d36cbbb77dc/spyder_kernels-3.0.5.tar.gz
        sha256: ff7a1e832eed723575882b86c81c8f82ed8d6929c05c399bac2771d605578cd8
        x-checker-data:
          type: pypi
          name: spyder-kernels

  - name: python-lsp-server
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/cc/0f/3d63c5f37edca529a2a003a30add97dcce67a83a99dd932528f623aa1df9/python_lsp_server-1.12.2.tar.gz
        sha256: fea039a36b3132774d0f803671184cf7dde0c688e7b924f23a6359a66094126d
        x-checker-data:
          type: pypi
          name: python-lsp-server

  - name: Spyder
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    post-install:
      - install -Dm0644 /app/share/icons/spyder.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/spyder.desktop
      - desktop-file-edit --set-key=Exec --set-value=spyder-wrapper ${FLATPAK_DEST}/share/applications/spyder.desktop
    sources:
      - type: git
        url: https://github.com/spyder-ide/spyder
        tag: v6.0.8
        commit: d8c09ce21cccb3d1350fe96e72c8bf150c96f8a8
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

    # Wait for 6.0.1
  # - name: spyder-terminal
  #   buildsystem: simple
  #   build-commands:
  #     - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
  #       --no-build-isolation .
  #   sources:
  #     - type: archive
  #       url: https://files.pythonhosted.org/packages/00/fe/a89d18983b9f7d881fa16089b418b7febfb9e1a2ea8f5a0ce39e59474859/spyder-terminal-1.2.2.tar.gz
  #       sha256: 34235070276a0cb255a5c371cbef076a355059a8a8c71fa9805df229ea0335da
  #       x-checker-data:
  #         type: pypi
  #         name: spyder-terminal

    # Tk is not included in Sdk and cannot be install with pip. Spyder itself does not require Tk but some libs like PySimpleGUI needs it.
    # Copy from org.thonny.Thonny.yaml
    # Do not cleanup /bin because wish is needed by gitk
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: 4f5cfe3cdd1f58cd4e136fd66d4e5e27d21d820b
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        config-opts:
          - --enable-threads
          - --enable-shared
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.15-src.tar.gz
            sha256: 861e159753f2e2fbd6ec1484103715b0be56be3357522b858d3cbb5f893ffef1
            # x-checker-data:
            #   type: anitya
            #   project-id: 4941
            #   stable-only: true
            #   url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod +w ${FLATPAK_DEST}/lib/libtk*.so
          - ln -sf /app/bin/wish8.6 /app/bin/wish
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.15-src.tar.gz
            sha256: 550969f35379f952b3020f3ab7b9dd5bfd11c1ef7c9b7c6a75f5c49aca793fec
            # x-checker-data:
            #   type: anitya
            #   project-id: 11426
            #   stable-only: true
            #   url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  - name: Spyder-flatpak-wrapper
    buildsystem: meson
    config-opts:
      - -Deditor_binary=/app/bin/spyder
      - -Deditor_args=--new-instance
      - -Dprogram_name=spyder-wrapper
      - -Deditor_title=Spyder IDE
      - -Dsdk_version=24.08
    sources:
      - type: git
        url: https://github.com/flathub/ide-flatpak-wrapper.git
        commit: e42aba9acceceb234216e60bb690705992517907
      - type: patch
        path: ide_first_run.patch

  - name: pythonstart
    buildsystem: simple
    build-commands:
      - cp pythonstart /app/etc/
    sources:
      - type: file
        path: pythonstart
